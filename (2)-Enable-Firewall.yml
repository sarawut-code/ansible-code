---
- name: Infrastructure Security - Firewall Control Automation
  hosts: all
  become: yes
  become_method: sudo  # ระบุวิธีเปลี่ยนสิทธิ์ให้ชัดเจน
  gather_facts: yes     # ให้ Ansible เก็บข้อมูลเครื่องก่อนเริ่ม

  vars:
    allowed_services:
      - http
      - ssh
    allowed_ports:
      - 10050/tcp

  tasks:
    # เพิ่ม Task นี้เพื่อตรวจสอบว่าเราเป็น root จริงไหม
    - name: 0. Verify effective user is root
      ansible.builtin.command: whoami
      register: user_status
      changed_when: false

    - name: 1. Install Python 3 if missing
      ansible.builtin.raw: test -e /usr/bin/python3 || (yum install -y python3 || apt-get install -y python3)
      changed_when: false

    - name: 2. Ensure Firewalld is installed
      ansible.builtin.package:
        name: firewalld
        state: present

    - name: 3. Ensure Firewalld is started and enabled
      ansible.builtin.service:
        name: firewalld
        state: started
        enabled: yes

    - name: 4. Allow Standard Services (HTTP, SSH)
      ansible.posix.firewalld:
        service: "{{ item }}"
        permanent: yes
        state: enabled
        immediate: yes
      loop: "{{ allowed_services }}"